name: CI/CD Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup .NET 8
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: 8.0.x

      - name: Restore dependencies
        run: dotnet restore OmmoBackend.sln

      - name: Build
        run: dotnet build OmmoBackend.sln --no-restore

      # - name: Run tests
      #   run: dotnet test OmmoBackend.sln --no-build --verbosity normal

      # ‚úÖ Publish into a temporary folder (safe build)
      - name: Publish
        run: dotnet publish OmmoBackend/OmmoBackend.csproj -c Release -r linux-x64 --self-contained false -o ./artifacts
      
      - name: Verify artifacts before deploy
        run: |
          echo "Runner artifacts:"
          pwd
          ls -la
          ls -la artifacts

      # ‚úÖ Step 1: Backup existing deployment
      - name: Backup existing deployment
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            APP_DIR="/var/www/ommo-backend-new"
            BACKUP_DIR="/var/www/backups/ommo-backend-new_$(date +'%Y-%m-%d_%H-%M-%S')"
            mkdir -p /var/www/backups
            if [ -d "$APP_DIR" ]; then
              cp -r "$APP_DIR" "$BACKUP_DIR"
              echo "‚úÖ Backup created at $BACKUP_DIR"
            else
              echo "‚ö†Ô∏è No existing deployment found, skipping backup."
            fi

      - name: Prepare deployment directory
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            rm -rf /var/www/ommo-backend-new/*

      - name: Prepare deployment directory (preserve important folders)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            APP_DIR="/var/www/ommo-backend-new"
            echo "Cleaning deployment folder but preserving important data..."
            find "$APP_DIR" -mindepth 1 ! -name 'Logs' \
                          ! -name 'ProfilePicture' \
                          ! -name 'Logo' \
                          ! -name 'Documents' \
                          ! -name 'appsettings.json' \
                          -exec rm -rf {} +
            echo "‚úÖ Preserved: Logs, ProfilePicture, Logo, Documents, appsettings.json"

      # ‚úÖ Step 2: Upload directly to /var/www/ommo-backend-new
      - name: Deploy to Server (via SCP)
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          source: "artifacts/*"
          target: "/var/www/ommo-backend-new"
          overwrite: true

      - name: Flatten deployment directory
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            if [ -d /var/www/ommo-backend-new/artifacts ]; then
              mv /var/www/ommo-backend-new/artifacts/* /var/www/ommo-backend-new/
              rm -rf /var/www/ommo-backend-new/artifacts
            fi

      - name: Verify files on server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            echo "Top-level:"
            ls -la /var/www/ommo-backend-new
            echo "Recursive:"
            find /var/www/ommo-backend-new -type f

      # ‚úÖ Step 3: Restart Application
      - name: Restart Application
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            sudo systemctl restart ommo-backend-new.service
            echo "üöÄ Service restarted successfully."