name: CI/CD Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup .NET 8
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: 8.0.x

      - name: Restore dependencies
        run: dotnet restore OmmoBackend.sln

      - name: Build
        run: dotnet build OmmoBackend.sln --no-restore

      # - name: Run tests
      #   run: dotnet test OmmoBackend.sln --no-build --verbosity normal

      - name: Publish
        run: dotnet publish -c Release -o ./publish

      # # ✅ Step 1: Backup current app
      # - name: Backup existing deployment
      #   uses: appleboy/ssh-action@v1.0.3
      #   with:
      #     host: ${{ secrets.SERVER_HOST }}
      #     username: ${{ secrets.SERVER_USER }}
      #     key: ${{ secrets.SERVER_SSH_KEY }}
      #     script: |
      #       APP_DIR="/var/www/ommo-backend-new"
      #       BACKUP_DIR="/var/www/backups/ommo-backend-new_$(date +'%Y-%m-%d_%H-%M-%S')"
      #       mkdir -p /var/www/backups
      #       if [ -d "$APP_DIR" ]; then
      #         cp -r "$APP_DIR" "$BACKUP_DIR"
      #         echo "Backup created at $BACKUP_DIR"
      #       else
      #         echo "App directory not found; skipping backup."
      #       fi

      # ✅ Step 2: Upload new published files
      - name: Deploy to Server (via SCP)
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          source: "./publish/*"
          target: "/var/www/ommo-backend-new-temp"

      # ✅ Step 3: Replace only code files (preserve Logs, Logo, ProfilePicture, Documents, appsettings.json)
      - name: Replace old build while preserving data
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            APP_DIR="/var/www/ommo-backend-new"
            TEMP_DIR="/var/www/ommo-backend-new-temp"

            echo "Deploying new version to $APP_DIR while preserving important folders..."

            # Create target dir if not exists
            mkdir -p "$APP_DIR"

            # Remove everything from APP_DIR except preserved folders/files
            find "$APP_DIR" -mindepth 1 ! -name 'Logs' ! -name 'Logo' ! -name 'ProfilePicture' ! -name 'Documents' ! -name 'appsettings.json' -exec rm -rf {} +

            # Move new files from temp dir to app dir
            cp -r "$TEMP_DIR"/* "$APP_DIR"

            # Cleanup temporary folder
            rm -rf "$TEMP_DIR"

            echo "Deployment completed. Preserved Logs, Logo, ProfilePicture, Documents, and appsettings.json."

      # ✅ Step 4: Restart the service
      - name: Restart Application (systemd)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            sudo systemctl restart ommo-backend-new.service
            echo "Service restarted successfully."
